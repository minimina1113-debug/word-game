
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼å­—å°„æ°£çƒéŠæˆ²</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Lucide icons for UI -->
    <script type="module" src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for the balloon game aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background: #f0f4f8; /* Light blue-gray background */
        }
        .container-wrapper {
            max-width: 1024px;
            margin: auto;
            min-height: 100vh;
            padding: 20px;
        }
        .balloon {
            /* Basic balloon shape - circle for simplicity */
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
            color: white;
            cursor: pointer;
            transition: transform 0.1s ease-out, background-color 0.3s, opacity 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            /* Animation for floating effect */
            animation: float 6s ease-in-out infinite;
        }

        .balloon:hover {
            transform: scale(1.05) translateY(-5px);
        }

        /* Balloon thread (simple ::after element) */
        .balloon::after {
            content: "";
            position: absolute;
            bottom: -20px;
            width: 2px;
            height: 20px;
            background: #4b5563; /* Gray thread */
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .game-area {
            min-height: 500px;
            background: linear-gradient(to top, #e0f7fa, #bbdefb);
            border-radius: 1rem;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        /* Styling for the disabled/incorrect balloon */
        .faded {
            opacity: 0.4;
            pointer-events: none;
            box-shadow: none;
        }
        
        .correct-pop {
            animation: pop-animation 0.5s forwards;
            pointer-events: none;
        }

        @keyframes pop-animation {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
            100% { transform: scale(0); opacity: 0; }
        }

    </style>
</head>
<body>

    <div id="app" class="container-wrapper">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-extrabold text-indigo-700 tracking-tight">
                å–®å­—æ‹¼å¯«å¤§æŒ‘æˆ°
            </h1>
            <p id="user-info" class="text-sm text-gray-500 mt-2">é€£ç·šç‹€æ…‹: è¼‰å…¥ä¸­...</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex justify-center space-x-4 mb-8">
            <button id="nav-tutorial" onclick="showSection('tutorial')" class="px-6 py-2 rounded-full font-bold transition duration-300 shadow-md bg-indigo-500 text-white hover:bg-indigo-600">
                ğŸ“š å–®å­—æ•™å­¸
            </button>
            <button id="nav-quiz" onclick="showSection('quiz')" class="px-6 py-2 rounded-full font-bold transition duration-300 shadow-md bg-gray-200 text-gray-700 hover:bg-gray-300">
                ğŸ¯ å°„æ°£çƒæ¸¬é©—
            </button>
        </div>

        <!-- 1. æ•™å­¸å€å¡Š -->
        <div id="tutorial-section" class="section hidden bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">A åˆ° M å¸¸è¦‹å–®å­—æ•™å­¸</h2>
            <div id="tutorial-content" class="overflow-x-auto">
                <!-- Word table will be generated here -->
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å­—æ¯</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å–®å­—</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è©æ€§</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸­æ–‡</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç™¼éŸ³</th>
                        </tr>
                    </thead>
                    <tbody id="word-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Content goes here -->
                    </tbody>
                </table>
            </div>
            <p class="mt-4 text-sm text-gray-600">é»æ“Šç™¼éŸ³æŒ‰éˆ•ï¼Œè½å–å–®å­—çš„æ¨™æº–è‹±èªç™¼éŸ³ã€‚</p>
        </div>

        <!-- 2. æ¸¬é©—å€å¡Š -->
        <div id="quiz-section" class="section hidden bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">ğŸ¯ å°„æ°£çƒæ‹¼å­—æ¸¬é©—</h2>
            
            <div id="quiz-controls" class="flex justify-between items-center mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <p id="quiz-score" class="text-xl font-bold text-gray-700">å¾—åˆ†: 0 / 10</p>
                <div>
                    <span class="font-medium text-gray-700 mr-2">æç¤ºæ¨¡å¼:</span>
                    <button id="hint-mode-btn" onclick="toggleHintMode()" class="px-4 py-2 rounded-full text-sm font-semibold transition duration-200 shadow-inner">
                        <!-- Initial text will be set by JS -->
                    </button>
                </div>
            </div>

            <div id="quiz-game-container" class="game-area p-8 flex flex-col justify-between">
                <!-- Hint Area -->
                <div id="hint-area" class="h-20 flex flex-col justify-center items-center mb-6">
                    <div id="hint-text-display" class="text-3xl font-bold text-indigo-800 bg-white p-3 rounded-lg shadow-xl min-w-[200px] text-center">
                        é»æ“Šé–‹å§‹æ¸¬é©—
                    </div>
                    <div id="audio-controls" class="mt-2 hidden">
                        <button id="replay-audio-btn" onclick="SpellingGame.replayAudio()" class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm font-medium hover:bg-indigo-200 transition flex items-center shadow-md">
                            <i data-lucide="volume-2" class="w-4 h-4 mr-1"></i>
                            é‡æ’­èªéŸ³
                        </button>
                    </div>
                </div>

                <!-- Balloon Area -->
                <div id="balloon-area" class="flex justify-around items-end flex-wrap h-64">
                    <!-- Balloons will be rendered here -->
                </div>
                
                <div class="flex justify-center mt-8">
                    <button id="start-quiz-btn" onclick="startQuiz()" class="px-8 py-3 bg-green-600 text-white text-xl font-bold rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105">
                        é–‹å§‹æ¸¬é©—
                    </button>
                </div>
            </div>

             <!-- Quiz result modal -->
            <div id="quiz-result-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="bg-white p-8 rounded-xl shadow-2xl text-center w-80">
                    <h3 id="modal-title" class="text-3xl font-bold text-indigo-700 mb-4">æ¸¬é©—çµæŸï¼</h3>
                    <p id="modal-message" class="text-xl text-gray-700 mb-6">æ­å–œä½ å®Œæˆæ‰€æœ‰é¡Œç›®ï¼</p>
                    <p id="modal-final-score" class="text-4xl font-extrabold text-green-600 mb-6">å¾—åˆ†: 0 / 10</p>
                    <button onclick="hideResultModal(); showSection('tutorial');" class="px-6 py-2 bg-indigo-500 text-white rounded-full font-semibold hover:bg-indigo-600 transition">
                        è¿”å›æ•™å­¸
                    </button>
                    <button onclick="hideResultModal(); startQuiz();" class="ml-4 px-6 py-2 bg-green-500 text-white rounded-full font-semibold hover:bg-green-600 transition">
                        å†ç©ä¸€æ¬¡
                    </button>
                </div>
            </div>

        </div>

        <!-- è¼‰å…¥ä¸­è¨Šæ¯ (ç”¨æ–¼APIå‘¼å«) -->
        <div id="loading-spinner" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
            <div class="flex flex-col items-center bg-white p-6 rounded-lg shadow-xl">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="loading-text" class="mt-3 text-lg font-medium text-indigo-600">èªéŸ³è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = 'anonymous';

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                    userId = userCredential.user.uid;
                } else {
                    const userCredential = await signInAnonymously(auth);
                    userId = userCredential.user.uid;
                }

                console.log("Firebase initialized and signed in. User ID:", userId);
                document.getElementById('user-info').textContent = `ä½¿ç”¨è€…ID: ${userId} | é€£ç·šæˆåŠŸ`;

                // Optional: Store a simple user record (Example of Firestore usage)
                const userRef = doc(collection(db, `artifacts/${appId}/users`), userId);
                await setDoc(userRef, { lastLogin: new Date().toISOString() }, { merge: true });

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
                document.getElementById('user-info').textContent = `é€£ç·šç‹€æ…‹: å¤±æ•— (${error.message})`;
                // Fallback userId if all else fails
                userId = crypto.randomUUID();
            }
        }

        window.onload = () => {
            // Wait for Firebase to initialize before showing the app content
            initFirebase().then(() => {
                window.SpellingGame.init();
                // Default to showing the tutorial section
                showSection('tutorial');
            });
        };

        window.showSection = (sectionName) => {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');

            document.querySelectorAll('button[id^="nav-"]').forEach(btn => {
                btn.classList.remove('bg-indigo-500', 'text-white', 'hover:bg-indigo-600');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });
            document.getElementById(`nav-${sectionName}`).classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            document.getElementById(`nav-${sectionName}`).classList.add('bg-indigo-500', 'text-white', 'hover:bg-indigo-600');
        }
    </script>
    

    <!-- Application Logic -->
    <script>
        // --- æ ¸å¿ƒå–®å­—è³‡æ–™ (a-m, å„4å€‹) ---
        const WORD_DATA = [
            { letter: 'A', word: 'apple', pos: 'N', translation: 'è˜‹æœ' },
            { letter: 'A', word: 'ant', pos: 'N', translation: 'èèŸ»' },
            { letter: 'A', word: 'ask', pos: 'V', translation: 'è©¢å•' },
            { letter: 'A', word: 'afraid', pos: 'Adj', translation: 'å®³æ€•çš„' },
            { letter: 'B', word: 'book', pos: 'N', translation: 'æ›¸' },
            { letter: 'B', word: 'bird', pos: 'N', translation: 'é³¥' },
            { letter: 'B', word: 'build', pos: 'V', translation: 'å»ºé€ ' },
            { letter: 'B', word: 'brave', pos: 'Adj', translation: 'å‹‡æ•¢çš„' },
            { letter: 'C', word: 'cat', pos: 'N', translation: 'è²“' },
            { letter: 'C', word: 'cake', pos: 'N', translation: 'è›‹ç³•' },
            { letter: 'C', word: 'clean', pos: 'V', translation: 'æ¸…æ½”' },
            { letter: 'C', word: 'cool', pos: 'Adj', translation: 'é…·çš„' },
            { letter: 'D', word: 'dog', pos: 'N', translation: 'ç‹—' },
            { letter: 'D', word: 'doll', pos: 'N', translation: 'æ´‹å¨ƒå¨ƒ' },
            { letter: 'D', word: 'dance', pos: 'V', translation: 'è·³èˆ' },
            { letter: 'D', word: 'dark', pos: 'Adj', translation: 'é»‘æš—çš„' },
            { letter: 'E', word: 'egg', pos: 'N', translation: 'è›‹' },
            { letter: 'E', word: 'ear', pos: 'N', translation: 'è€³æœµ' },
            { letter: 'E', word: 'eat', pos: 'V', translation: 'åƒ' },
            { letter: 'E', word: 'easy', pos: 'Adj', translation: 'ç°¡å–®çš„' },
            { letter: 'F', word: 'fish', pos: 'N', translation: 'é­š' },
            { letter: 'F', word: 'flower', pos: 'N', translation: 'èŠ±' },
            { letter: 'F', word: 'find', pos: 'V', translation: 'æ‰¾åˆ°' },
            { letter: 'F', word: 'fast', pos: 'Adj', translation: 'å¿«é€Ÿçš„' },
            { letter: 'G', word: 'girl', pos: 'N', translation: 'å¥³å­©' },
            { letter: 'G', word: 'gift', pos: 'N', translation: 'ç¦®ç‰©' },
            { letter: 'G', word: 'go', pos: 'V', translation: 'å»' },
            { letter: 'G', word: 'great', pos: 'Adj', translation: 'å‰å¤§çš„' },
            { letter: 'H', word: 'house', pos: 'N', translation: 'æˆ¿å­' },
            { letter: 'H', word: 'hat', pos: 'N', translation: 'å¸½å­' },
            { letter: 'H', word: 'have', pos: 'V', translation: 'æ“æœ‰' },
            { letter: 'H', word: 'happy', pos: 'Adj', translation: 'å¿«æ¨‚çš„' },
            { letter: 'I', word: 'ice', pos: 'N', translation: 'å†°' },
            { letter: 'I', word: 'insect', pos: 'N', translation: 'æ˜†èŸ²' },
            { letter: 'I', word: 'invite', pos: 'V', translation: 'é‚€è«‹' },
            { letter: 'I', word: 'important', pos: 'Adj', translation: 'é‡è¦çš„' },
            { letter: 'J', word: 'juice', pos: 'N', translation: 'æœæ±' },
            { letter: 'J', word: 'jet', pos: 'N', translation: 'å™´å°„æ©Ÿ' },
            { letter: 'J', word: 'jump', pos: 'V', translation: 'è·³èº' },
            { letter: 'J', word: 'jealous', pos: 'Adj', translation: 'å«‰å¦’çš„' },
            { letter: 'K', word: 'key', pos: 'N', translation: 'é‘°åŒ™' },
            { letter: 'K', word: 'kite', pos: 'N', translation: 'é¢¨ç®' },
            { letter: 'K', word: 'kick', pos: 'V', translation: 'è¸¢' },
            { letter: 'K', word: 'kind', pos: 'Adj', translation: 'å–„è‰¯çš„' },
            { letter: 'L', word: 'lamp', pos: 'N', translation: 'ç‡ˆ' },
            { letter: 'L', word: 'lion', pos: 'N', translation: 'ç…å­' },
            { letter: 'L', word: 'look', pos: 'V', translation: 'çœ‹' },
            { letter: 'L', word: 'lucky', pos: 'Adj', translation: 'å¹¸é‹çš„' },
            { letter: 'M', word: 'man', pos: 'N', translation: 'ç”·äºº' },
            { letter: 'M', word: 'monkey', pos: 'N', translation: 'çŒ´å­' },
            { letter: 'M', word: 'make', pos: 'V', translation: 'è£½ä½œ' },
            { letter: 'M', word: 'mean', pos: 'Adj', translation: 'åˆ»è–„çš„' },
        ];

        // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸ ---
        let quizWords = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let hintMode = 'audio'; // 'audio' or 'chinese'

        // --- èªéŸ³/éŸ³æ•ˆç›¸é—œ ---
        let synth;
        let audioContext;
        let currentQuizWord = null; // Store the word for the current quiz question
        let isWaitingForAnswer = false; // Flag to prevent multiple clicks and control auto-advance

        const showLoading = (text) => {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-spinner').classList.remove('hidden');
        };

        const hideLoading = () => {
            document.getElementById('loading-spinner').classList.add('hidden');
        };

        // Function to convert Base64 audio (PCM) to WAV Blob
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate = 24000) {
            const numChannels = 1;
            const numSamples = pcm16.length;
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);

            let offset = 0;

            // RIFF chunk descriptor
            writeString('RIFF');
            view.setUint32(offset, 36 + numSamples * 2, true); offset += 4;
            writeString('WAVE');

            // FMT sub-chunk
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4; // Sub-chunk size
            view.setUint16(offset, 1, true); offset += 2; // Audio format (1 = PCM)
            view.setUint16(offset, numChannels, true); offset += 2; // Number of channels
            view.setUint32(offset, sampleRate, true); offset += 4; // Sample rate
            view.setUint32(offset, sampleRate * numChannels * 2, true); offset += 4; // Byte rate
            view.setUint16(offset, numChannels * 2, true); offset += 2; // Block align
            view.setUint16(offset, 16, true); offset += 2; // Bits per sample

            // DATA sub-chunk
            writeString('data');
            view.setUint32(offset, numSamples * 2, true); offset += 4; // Sub-chunk size

            // Write PCM data
            for (let i = 0; i < numSamples; i++) {
                view.setInt16(offset, pcm16[i], true); offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });

            function writeString(s) {
                for (let i = 0; i < s.length; i++) {
                    view.setUint8(offset + i, s.charCodeAt(i));
                }
                offset += s.length;
            }
        }
        
        /**
         * Utility for making API calls with exponential backoff for resilience.
         */
        async function makeApiCallWithBackoff(apiUrl, payload, maxRetries = 3) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response;
                    } 
                    
                    // Attempt to parse error details from JSON body for non-OK responses
                    let errorDetail = response.statusText;
                    try {
                        const errorBody = await response.json();
                        // Check for common Gemini error structure
                        if (errorBody && errorBody.error && errorBody.error.message) {
                            errorDetail = errorBody.error.message;
                        } else if (errorBody && errorBody.message) {
                            errorDetail = errorBody.message;
                        }
                    } catch (e) {
                        // Failed to parse JSON body, stick with statusText
                    }

                    if (response.status === 429 || response.status >= 500) {
                        // Rate limit or server error - retry
                        if (i < maxRetries - 1) {
                            console.warn(`API call failed with status ${response.status}. Retrying in ${delay / 1000}s. Detail: ${errorDetail}`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponential delay increase
                        } else {
                            throw new Error(`API call failed after ${maxRetries} retries: Status ${response.status} - ${errorDetail}`);
                        }
                    } else {
                        // Non-retryable error (e.g., 400 Bad Request, 403 Forbidden)
                        throw new Error(`API call failed: Status ${response.status} - ${errorDetail}`);
                    }
                } catch (error) {
                    if (i < maxRetries - 1 && (error.message.includes('Failed to fetch') || error.message.includes('timeout'))) {
                        // Network error - retry
                        console.warn(`Network error. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
        }

        /**
         * Calls the Gemini TTS API to get audio data for a given text.
         * @param {string} text The text (English word) to convert to speech.
         * @returns {string} A Blob URL for the playable audio.
         */
        async function getAudioBlobUrl(text) {
            // Add a conversational wrapper and explicit language to stabilize TTS generation
            const ttsPrompt = `Pronounce the English word clearly: ${text}`;

            const payload = {
                contents: [{
                    parts: [{ text: ttsPrompt }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { 
                                voiceName: "Achird",
                                languageCode: "en-US" // Explicitly set language
                            }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            try {
                // Use the backoff mechanism here
                const response = await makeApiCallWithBackoff(apiUrl, payload);

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType; // Should be audio/L16;rate=24000

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData); // API returns signed PCM16
                    
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    return URL.createObjectURL(wavBlob);
                } else {
                    console.error("TTS response missing or invalid audio data.", result);
                    if (result.candidates?.[0]?.finishReason === "OTHER") {
                        throw new Error("TTS generation failed (OTHER reason).");
                    }
                    return null;
                }
            } catch (error) {
                console.error("Error generating speech after retries:", error);
                return null;
            }
        }

        // --- Tone.js éŸ³æ•ˆ ---
        function playCorrectSound() {
            if (synth) {
                // Ding-dong sound (simple two-note arpeggio)
                synth.triggerAttackRelease("C5", "8n");
                synth.triggerAttackRelease("E5", "8n", "+0.15");
            }
        }

        function playIncorrectSound() {
            if (synth) {
                // Low buzzer sound
                synth.triggerAttackRelease("C3", "8n");
            }
        }

        // --- è¼”åŠ©å‡½æ•¸ ---

        function getRandomSubarray(arr, size, excludeWord = null) {
            const shuffled = [...arr].filter(item => item.word !== excludeWord);
            let result = [];
            for (let i = 0; i < size; i++) {
                const randomIndex = Math.floor(Math.random() * (shuffled.length - i));
                result.push(shuffled.splice(randomIndex, 1)[0]);
            }
            return result;
        }

        // --- æ ¸å¿ƒéŠæˆ²é‚è¼¯ ---

        window.SpellingGame = {
            init: () => {
                // Initialize Tone.js components
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                Tone.setContext(audioContext);
                synth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "triangle" }
                }).toDestination();
                
                // Render Tutorial content on load
                SpellingGame.renderTutorial();
                
                // Initialize hint mode button
                SpellingGame.updateHintButtonText();
                // Render Lucide icons for audio controls
                lucide.createIcons();
            },
            
            renderTutorial: () => {
                const tableBody = document.getElementById('word-table-body');
                tableBody.innerHTML = '';
                
                WORD_DATA.forEach(data => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.letter}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-indigo-600">${data.word}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.pos}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${data.translation}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="playTTS('${data.word}')" class="text-indigo-500 hover:text-indigo-700 font-semibold flex items-center transition">
                                <i data-lucide="volume-2" class="w-5 h-5 mr-1"></i>
                                ç™¼éŸ³
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                // Re-render lucide icons
                lucide.createIcons();
            },

            // New function to handle manual audio replay
            replayAudio: () => {
                if (currentQuizWord && quizWords[currentQuestionIndex - 1]) {
                    // Re-trigger audio hint only. Note: currentQuestionIndex is already incremented, so use -1
                    window.playTTS(currentQuizWord, true, true);
                }
            },

            // State management
            updateScoreDisplay: () => {
                document.getElementById('quiz-score').textContent = `å¾—åˆ†: ${score} / 10 | é¡Œè™Ÿ: ${currentQuestionIndex + 1}`;
                if (currentQuestionIndex >= 10) {
                     document.getElementById('quiz-score').textContent = `å¾—åˆ†: ${score} / 10 | é¡Œè™Ÿ: 10 / 10`;
                }
            },

            updateHintButtonText: () => {
                const btn = document.getElementById('hint-mode-btn');
                if (hintMode === 'audio') {
                    btn.textContent = 'ğŸ”Š èªéŸ³ç™¼éŸ³æç¤º';
                    btn.classList.remove('bg-blue-200', 'text-blue-800');
                    btn.classList.add('bg-purple-200', 'text-purple-800');
                } else {
                    btn.textContent = 'ğŸ“ ä¸­æ–‡ç¿»è­¯æç¤º';
                    btn.classList.remove('bg-purple-200', 'text-purple-800');
                    btn.classList.add('bg-blue-200', 'text-blue-800');
                }
            },
            
            checkAnswer: (selectedWord, element) => {
                if (!isWaitingForAnswer) return; // Prevent double clicks
                isWaitingForAnswer = false;

                // Index is based on the question that was rendered *before* incrementing
                const currentQuestion = quizWords[currentQuestionIndex - 1]; 
                
                // Disable all balloons after selection
                document.querySelectorAll('#balloon-area button').forEach(btn => {
                    btn.onclick = null;
                });

                document.getElementById('audio-controls').classList.add('hidden'); // Hide controls after answering

                // --- æ ¸å¿ƒä¿®æ­£ï¼šç­”æ¡ˆæ¯”å° ---
                // æ¯”å° selectedWord (å¾æ°£çƒçš„ data-word ä¾†) èˆ‡ currentQuestion.word (å…§éƒ¨æ­£ç¢ºç­”æ¡ˆ)
                if (selectedWord === currentQuestion.word) {
                    playCorrectSound();
                    score++;
                    element.classList.add('bg-green-500', 'correct-pop');
                    document.getElementById('hint-text-display').textContent = `âœ… æ­£ç¢ºï¼${currentQuestion.word} (${currentQuestion.translation})`;
                    
                    // --- è‡ªå‹•è·³è½‰ (ä¿®æ­£è¦æ±‚ 2) ---
                    setTimeout(() => {
                        window.nextQuestion();
                    }, 1500);

                } else {
                    playIncorrectSound();
                    element.classList.add('faded', 'bg-red-500'); // Fade out incorrect
                    document.getElementById('hint-text-display').textContent = `âŒ éŒ¯èª¤ï¼è«‹å†è©¦ä¸€æ¬¡ã€‚`;
                    
                    // Re-enable remaining balloons and set status back to waiting for correct answer
                    document.querySelectorAll('#balloon-area button').forEach(btn => {
                        if (!btn.classList.contains('faded')) {
                            const word = btn.getAttribute('data-word');
                            btn.onclick = (e) => SpellingGame.checkAnswer(word, btn);
                        }
                    });

                    // Re-show replay button if hint mode is audio
                    if (hintMode === 'audio') {
                        document.getElementById('audio-controls').classList.remove('hidden');
                    }
                    isWaitingForAnswer = true; // Still waiting for the correct answer
                }
                
                SpellingGame.updateScoreDisplay();
            },

            renderQuestion: (question) => {
                const balloonArea = document.getElementById('balloon-area');
                balloonArea.innerHTML = '';
                
                document.getElementById('start-quiz-btn').classList.add('hidden');
                isWaitingForAnswer = true; // Ready for a new answer

                currentQuizWord = question.word; // Set the current quiz word state

                const correctWord = question.word;
                const distractors = getRandomSubarray(WORD_DATA, 3, correctWord); // Get 3 incorrect words
                
                const allChoices = [question, ...distractors].sort(() => Math.random() - 0.5);

                // 1. Render Hint
                if (hintMode === 'audio') {
                    // --- ä¿®æ­£è¦æ±‚ 1: èªéŸ³æ¨¡å¼ä¸‹ï¼Œåªé¡¯ç¤ºèªéŸ³åœ–ç¤ºå’ŒæŒ‡ä»¤ï¼Œä¸é¡¯ç¤ºå–®å­— ---
                    document.getElementById('hint-text-display').innerHTML = `<i data-lucide="volume-2" class="w-6 h-6 inline-block mr-2"></i> è«‹è½ç™¼éŸ³ï¼Œå°„ä¸‹å°æ‡‰çš„å–®å­—ï¼`;
                    lucide.createIcons(); 
                    document.getElementById('audio-controls').classList.remove('hidden'); // Show replay button
                    window.playTTS(correctWord, true, true); // autoPlay = true
                } else {
                    document.getElementById('hint-text-display').textContent = `ä¸­æ–‡æç¤ºï¼š${question.translation} (${question.pos})`;
                    document.getElementById('audio-controls').classList.add('hidden'); // Hide replay button
                }

                // 2. Render Balloons
                allChoices.forEach((choice, index) => {
                    // Random color classes
                    const colors = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500'];
                    const colorClass = colors[index % colors.length];

                    const balloon = document.createElement('button');
                    balloon.className = `balloon ${colorClass} text-white hover:shadow-2xl hover:scale-105 transition-all`;
                    balloon.style.setProperty('animation-delay', `${index * 0.5}s`);
                    // é—œéµï¼šå°‡æ­£ç¢ºç­”æ¡ˆå„²å­˜ç‚º data å±¬æ€§ï¼Œä¾› checkAnswer å‡½æ•¸æ¯”å°
                    balloon.setAttribute('data-word', choice.word); 
                    balloon.innerHTML = `<span class="pointer-events-none">${choice.word}</span>`;
                    
                    // Attach click handler
                    balloon.onclick = (e) => SpellingGame.checkAnswer(choice.word, balloon);

                    balloonArea.appendChild(balloon);
                });
            }
        };

        // --- Global functions for buttons ---

        window.toggleHintMode = () => {
            hintMode = hintMode === 'audio' ? 'chinese' : 'audio';
            SpellingGame.updateHintButtonText();
            // Re-render current question if quiz is active
            if (quizWords.length > 0 && currentQuestionIndex > 0 && currentQuestionIndex <= 10) {
                 // Re-render the previously rendered question to update the hint text
                 SpellingGame.renderQuestion(quizWords[currentQuestionIndex - 1]);
            }
        };

        window.playTTS = async (text, isQuizHint = false, autoPlay = false) => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const hintDisplay = document.getElementById('hint-text-display');
            
            // 1. Set playing status
            if(isQuizHint) {
                // For quiz, just show playing status, but keep replay button
                // We show the "loading" message inside the spinner
                if (autoPlay && hintMode === 'audio') {
                     // Set a temporary message while loading is active
                    hintDisplay.innerHTML = `<i data-lucide="volume-2" class="w-6 h-6 inline-block mr-2"></i> èªéŸ³æ’­æ”¾ä¸­...`;
                    lucide.createIcons();
                }
            }

            showLoading(isQuizHint ? 'èªéŸ³æç¤ºè¼‰å…¥ä¸­...' : 'ç™¼éŸ³è¼‰å…¥ä¸­...');
            const audioUrl = await getAudioBlobUrl(text);
            hideLoading();

            if (audioUrl) {
                const audio = new Audio(audioUrl);
                audio.play().catch(e => console.error("Audio playback failed:", e));
                
                audio.onended = () => {
                    // Clean up Blob URL after playback
                    URL.revokeObjectURL(audioUrl);
                    
                    if(isQuizHint && hintMode === 'audio') {
                         // Reset the hint text display to the static instruction after playing in quiz mode
                         hintDisplay.innerHTML = `<i data-lucide="volume-2" class="w-6 h-6 inline-block mr-2"></i> è«‹è½ç™¼éŸ³ï¼Œå°„ä¸‹å°æ‡‰çš„å–®å­—ï¼`;
                         lucide.createIcons();
                    }
                };
            } else {
                // 3. Handle failure
                const errorMessage = "âŒ èªéŸ³ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– API ç‹€æ…‹ã€‚";
                
                if (isQuizHint && hintMode === 'audio') {
                    // Quiz error: show error message but KEEP the replay button for manual retry
                    hintDisplay.textContent = errorMessage;
                    document.getElementById('audio-controls').classList.remove('hidden'); 
                } else {
                    // Tutorial/Manual error: temporarily show the error in the loading spinner
                    showLoading(errorMessage);
                    setTimeout(hideLoading, 3000);
                }
            }
        };

        window.startQuiz = () => {
            // 1. Reset state
            currentQuestionIndex = 0;
            score = 0;
            currentQuizWord = null; // Reset word state
            
            // 2. Select 10 random words for the quiz
            quizWords = getRandomSubarray(WORD_DATA, 10);
            
            // 3. Start first question
            nextQuestion();
        };
        
        window.nextQuestion = () => {
            if (currentQuestionIndex >= 10) {
                showResultModal();
                return;
            }

            const currentQuestion = quizWords[currentQuestionIndex];
            SpellingGame.updateScoreDisplay();
            SpellingGame.renderQuestion(currentQuestion);
            currentQuestionIndex++; // Advance index after rendering
        };
        
        window.showResultModal = () => {
            document.getElementById('modal-final-score').textContent = `å¾—åˆ†: ${score} / 10`;
            document.getElementById('quiz-result-modal').classList.remove('hidden');
        };

        window.hideResultModal = () => {
            document.getElementById('quiz-result-modal').classList.add('hidden');
            // Clear balloon area after quiz ends
            document.getElementById('balloon-area').innerHTML = '';
            document.getElementById('hint-text-display').textContent = `é»æ“Šé–‹å§‹æ¸¬é©—`;
            document.getElementById('start-quiz-btn').classList.remove('hidden');
            document.getElementById('audio-controls').classList.add('hidden');
            currentQuizWord = null;
            // Update score display to show 0/10 and 'é¡Œè™Ÿ: 1 / 10'
            currentQuestionIndex = 0;
            score = 0;
            SpellingGame.updateScoreDisplay();
        };

        // Make sure the audio context starts only after user interaction
        document.addEventListener('click', () => {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });

        // Initialize score display for the first time
        SpellingGame.updateScoreDisplay(); 

    </script>
</body>
</html>