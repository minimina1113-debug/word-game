<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ² ä¹˜æ³•ä½”é ˜ç­–ç•¥éŠæˆ²</title>
    <style>
        /* CSS æ¨£å¼ V7.0 */
        :root {
            --player1-color: #f44336; /* ç´… */
            --player2-color: #2196F3; /* è— */
            --player3-color: #4CAF50; /* ç¶  */
            --player4-color: #FFC107; /* é»ƒ */
            --retired-color: #9E9E9E; /* æ£„æ¬Šç°è‰² */
            --neutral-color: #ddd;
            --background-color: #f8f8f8;
            --main-font: 'Microsoft JhengHei', Arial, sans-serif;
            --primary-color: #3F51B5;
            --secondary-color: #FF9800;
            --text-on-color: #000; /* å½©è‰²èƒŒæ™¯ä¸Šçš„æ–‡å­—é¡è‰² */
        }

        body {
            font-family: var(--main-font);
            background-color: var(--background-color);
            color: #333;
            margin: 0;
            padding: 20px;
            text-align: center;
            user-select: none;
        }

        .container {
            max-width: 1200px; 
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 2em;
        }

        /* é é¢åˆ‡æ›ç›¸é—œ */
        .page {
            display: none;
            padding: 20px 0;
            min-height: 400px;
            text-align: left;
        }
        
        .page h2 {
            color: var(--player1-color);
            border-bottom: 2px solid #ccc;
            padding-bottom: 10px;
        }

        /* éŠæˆ²ä¸»ç•«é¢ä½ˆå±€ V7.0 (1:2:1 æ¯”ä¾‹) */
        #gameLayout {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        /* å·¦å³å…©å´çš„ç©å®¶/æ§åˆ¶å€ (ç´„ 25% å¯¬åº¦) */
        .player-control-area {
            width: 25%; 
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fafafa;
            min-height: 600px;
            box-sizing: border-box; 
        }

        /* ä¸­é–“æ£‹ç›¤å€ (ç´„ 50% å¯¬åº¦) */
        #gameSection {
            width: 50%;
            padding: 0 15px;
            text-align: center;
            box-sizing: border-box;
        }

        /* æ£‹ç›¤ */
        #gameBoard {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            width: 100%;
            margin: 20px auto;
            max-width: 360px; 
        }

        .cell {
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2em;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: var(--neutral-color);
            color: #333;
        }
        
        /* ç©å®¶é¡è‰²æ¨£å¼ */
        .p1 { background-color: var(--player1-color); color: white; }
        .p2 { background-color: var(--player2-color); color: white; }
        .p3 { background-color: var(--player3-color); color: white; }
        .p4 { background-color: var(--player4-color); color: white; }
        .retired { background-color: var(--retired-color); opacity: 0.6; pointer-events: none; }
        
        /* ç©å®¶è³‡è¨Šèˆ‡è¨ˆæ™‚å™¨ */
        .player-info-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            color: var(--text-on-color); 
            transition: border-color 0.3s, opacity 0.3s;
        }
        .current-turn {
            border: 4px solid var(--secondary-color) !important;
            box-shadow: 0 0 10px rgba(255, 152, 0, 0.5);
        }
        .player-score-name {
            font-weight: bold;
            font-size: 1.1em;
            display: block;
            margin-bottom: 3px;
        }
        .score-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        .mistake-info {
            font-size: 0.9em;
            font-style: italic;
            margin-top: 5px;
        }
        
        /* è¨ˆæ™‚å™¨ */
        .timer-display {
            font-size: 1.8em;
            font-weight: bold;
            text-align: right;
            padding: 5px;
            color: var(--text-on-color);
        }

        /* éª°å­æ§åˆ¶ */
        #diceControl {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
        }
        #diceDisplay {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 10px 0;
        }
        .dice-number {
            font-size: 2.2em;
            width: 60px;
            height: 60px;
            line-height: 60px;
            background: var(--neutral-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .dice-selected {
            background: var(--secondary-color);
            color: white;
            border: 3px solid #E68A00;
        }
        
        /* Modal æ¨£å¼èª¿æ•´: ç½®ä¸­ä¸¦è¦†è“‹ */
        #gameOverModal, #smartModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            text-align: center;
        }
        .modal-content button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ² ä¹˜æ³•ä½”é ˜ç­–ç•¥éŠæˆ²</h1>

        <div id="modeSelectPage" class="page" style="display: block;">
            <h2>æ­¡è¿ä¾†åˆ°ä¹˜æ³•ä½”é ˜éŠæˆ²ï¼</h2>

            <div class="selection-group">
                <h3>é¸æ“‡éŠæˆ²æ¨¡å¼</h3>
                <button onclick="setGameMode('learning')">å­¸ç¿’æ¨¡å¼</button>
                <button onclick="setGameMode('challenge')">æŒ‘æˆ°æ¨¡å¼</button>
                <p style="text-align: center; margin-top: 15px; color: #555;">(æ‚¨ç›®å‰é¸æ“‡çš„æ¨¡å¼ï¼š<span id="currentModeDisplay" style="color:var(--player1-color);">è«‹é¸æ“‡</span>)</p>
            </div>
            
            <div class="selection-group">
                <h3>é¸æ“‡ç©å®¶äººæ•¸</h3>
                <label><input type="radio" name="playerCount" value="2" checked> 2 äºº</label>
                <label><input type="radio" name="playerCount" value="3"> 3 äºº</label>
                <label><input type="radio" name="playerCount" value="4"> 4 äºº</label>
            </div>

            <button class="next-button" onclick="goToRulesPage()">ä¸‹ä¸€æ­¥ï¼šæŸ¥çœ‹éŠæˆ²èªªæ˜</button>
        </div>

        <div id="rulesPage" class="page">
            <h2>ğŸ“œ éŠæˆ²æ–¹å¼èªªæ˜ (V7.0)</h2>
            
            <p>æœ¬éŠæˆ²ç‚ºå¤šäººå›åˆåˆ¶ä¹˜æ³•ç­–ç•¥éŠæˆ²ï¼Œç›®æ¨™æ˜¯ä½”é ˜æ£‹ç›¤ä¸Šæœ€å¤šçš„æ•¸å­—æ–¹æ ¼ï¼Œä¸¦ç›¡é‡å‰µé€ ç›¸é€£å€å¡Šã€‚</p>

            <h3>éŠæˆ²æµç¨‹èˆ‡è¦å‰‡é‡é»</h3>
            <ul>
                <li>ğŸ² **æ“²éª°å­ï¼š** è¼ªåˆ°æ‚¨çš„å›åˆæ™‚ï¼Œé»æ“Šã€Œæ“²éª°å­ã€æŒ‰éˆ•ï¼Œç²å¾—ä¸‰å€‹æ•¸å­— (1~10)ã€‚</li>
                <li>âœ–ï¸ **é¸æ“‡ä¹˜ç©ï¼š** é»é¸å…¶ä¸­å…©å€‹æ•¸å­—è¨ˆç®—ä¹˜ç©ï¼Œä¸¦åœ¨æ£‹ç›¤ä¸Šä½”é ˜å°æ‡‰æ•¸å­—ã€‚</li>
                <li>ğŸ¯ **æˆåŠŸä½”é ˜ï¼š** æˆåŠŸä½”é ˜å¾Œï¼Œç«‹å³æ›ä¸‹ä¸€ä½ç©å®¶ã€‚</li>
                <li>âš ï¸ **å¤±èª¤èˆ‡æ‡²ç½°æ©Ÿåˆ¶ (æ‰€æœ‰æ¨¡å¼é©ç”¨)ï¼š**
                    <ul>
                        <li>å¦‚æœç¶²æ ¼ä¸­æœ‰å¯ä½”é ˜çš„ä¹˜ç©ï¼Œä½†ç©å®¶é¸æ“‡é‡éª°ï¼Œå°‡è¢«è¨˜éŒ„ç‚º**ä¸€æ¬¡å¤±èª¤**ã€‚</li>
                        <li>ç©å®¶å…±æœ‰ **3 æ¬¡**å¤±èª¤æ©Ÿæœƒã€‚</li>
                        <li>ç•¶å¤±èª¤æ¬¡æ•¸é”åˆ° 3 æ¬¡ (ç¬¬ 4 æ¬¡å¤±èª¤)ï¼Œè©²ç©å®¶å°‡**ç›´æ¥æ£„æ¬Š**ï¼Œé€€å‡ºéŠæˆ²ã€‚</li>
                        <li>å¦‚æœåªå‰©ä¸‹ä¸€ä½ç©å®¶ä»åœ¨éŠæˆ²ä¸­ï¼ŒéŠæˆ²å°‡ç«‹å³çµæŸã€‚</li>
                    </ul>
                </li>
            </ul>

            <h3>è¨ˆåˆ†æ–¹å¼</h3>
            <ul>
                <li>â­ ç©å®¶æ¯ä½”é ˜ 1 å€‹æ–¹æ ¼å¾— **1 åˆ†**ã€‚</li>
                <li>â• **ç›¸é€£å€å¡Šå¾—åˆ†ï¼š** å¦‚ä½”é ˜å€å¡Šç›¸é€£ï¼ˆä¸Šä¸‹å·¦å³ï¼‰ï¼Œè©²å›åˆå¾—åˆ†ç‚º**é›™å€**ã€‚</li>
                <li>ğŸ”¢ éŠæˆ²çµæŸæ™‚ï¼Œç©åˆ†æœ€é«˜çš„ç©å®¶ç²å‹ã€‚</li>
            </ul>
            
            <button class="next-button" onclick="goToNameInputPage()">ä¸‹ä¸€æ­¥ï¼šè¼¸å…¥ç©å®¶åç¨±</button>
        </div>

        <div id="nameInputPage" class="page">
            <h2>ğŸ‘¤ è¼¸å…¥ç©å®¶ç¨±å‘¼</h2>
            <p>è«‹ç‚ºæ‰€æœ‰ç©å®¶è¼¸å…¥ä¸€å€‹ç¨±å‘¼ï¼š</p>

            <div id="playerInputs">
                </div>

            <button class="next-button" onclick="startGame()">é–‹å§‹éŠæˆ²</button>
        </div>

        <div id="gameBoardPage" class="page">
            
            <div id="gameLayout">
                <div id="leftPlayerArea" class="player-control-area">
                    <h3>ç©å®¶è³‡è¨Š</h3>
                    <div id="playerInfoLeft"></div>
                </div>

                <div id="gameSection">
                    <div id="diceControl">
                        <h4>é¸æ“‡å…©å€‹æ•¸å­—è¨ˆç®—ä¹˜ç©</h4>
                        <div id="diceDisplay">
                            </div>
                        <div id="selectedProduct" style="margin: 10px 0; font-weight: bold;">
                             </div>
                        
                        <div id="controlButtons">
                            <button id="rollDiceButton" onclick="handleRoll()">ğŸ² æ“²éª°å­</button>
                            <button id="reRollButton" onclick="handleReRoll()" disabled>ğŸ”„ é‡éª°</button>
                        </div>
                        <div id="gameFeedback" style="color: var(--primary-color); margin-top: 10px;"></div>
                    </div>
                    
                    <div id="gameBoard">
                        </div>
                </div>

                <div id="rightPlayerArea" class="player-control-area">
                    <h3>ç©å®¶è³‡è¨Š</h3>
                    <div id="playerInfoRight"></div>
                </div>
            </div>
            
        </div>
        
        <div id="gameOverModal" style="display: none;">
            <div class="modal-content">
                <h2>éŠæˆ²çµæŸï¼</h2>
                <p id="winnerMessage"></p>
                <button id="restartButton" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
            </div>
        </div>

        <div id="smartModal" style="display: none;">
            <div class="modal-content">
                <p id="modalMessage"></p>
                <button id="modalConfirmButton" onclick="handleModalConfirm()">ç¢ºå®š</button>
            </div>
        </div>
    </div>

    <script>
        // JavaScript é‚è¼¯ V7.0
        
        // --- éŠæˆ²ç‹€æ…‹è®Šæ•¸ ---
        let cells = [];             
        let players = [];           
        let playerCount = 2;        
        let currentPlayerIndex = 0; 
        let currentDice = [0, 0, 0]; 
        let selectedDice = [];      
        let currentProduct = 0;     
        let gameMode = 'learning';  
        let skipCount = 0;          // é€£çºŒç„¡è§£é‡éª°æ¬¡æ•¸

        // è¨ˆæ™‚å™¨è®Šæ•¸
        let timerInterval;
        let timeInSeconds = 0;      
        const CHALLENGE_TIME = 30;  
        const MISTAKE_LIMIT = 3;    // å¤±èª¤æ¬¡æ•¸ä¸Šé™

        const PLAYER_CLASSES = ['p1', 'p2', 'p3', 'p4']; 
        const BOARD_SIZE = 6;
        let boardValues = [];       
        let availableCells = [];    
        
        // --- è¼”åŠ©å‡½æ•¸ ---

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomUnique(arr, n) {
            const shuffled = arr.slice(0);
            let i = arr.length;
            let min = i - n;
            let temp, index;
            while (i-- > min) {
                index = Math.floor((i + 1) * Math.random());
                temp = shuffled[index];
                shuffled[index] = shuffled[i];
                shuffled[i] = temp;
            }
            return shuffled.slice(min);
        }

        /**
         * æª¢æŸ¥çµ¦å®šçš„ä¸‰å€‹æ•¸å­—ï¼Œæ˜¯å¦æœ‰ä»»ä½•å…©å€‹ä¹˜ç©å¯ä»¥åœ¨æ£‹ç›¤ä¸Šè¢«ä½”é ˜ï¼Œ
         * ä¸¦è¿”å›ç¬¬ä¸€å€‹å¯ç”¨çš„ä¹˜æ•¸çµ„åˆ (e.g., [4, 5])
         */
        function checkSolvable(rolls, available) {
            const products = [];
            const productSets = [];
            for (let i = 0; i < 3; i++) {
                for (let j = i + 1; j < 3; j++) {
                    const p = rolls[i] * rolls[j];
                    products.push(p);
                    productSets.push([rolls[i], rolls[j]]);
                }
            }
            
            for (let i = 0; i < products.length; i++) {
                if (available.includes(products[i])) {
                    return productSets[i]; // è¿”å›ä¸€çµ„å¯ç”¨çš„ä¹˜æ•¸
                }
            }
            return null; // ç„¡è§£
        }


        // --- é é¢èˆ‡åˆå§‹åŒ–æ§åˆ¶ ---

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.style.display = 'none';
            });
            document.getElementById(pageId).style.display = 'block';
        }

        function setGameMode(mode) {
            gameMode = mode;
            const display = document.getElementById('currentModeDisplay');
            if (mode === 'learning') {
                display.textContent = 'å­¸ç¿’æ¨¡å¼ (æ­£å‘è¨ˆæ™‚)';
            } else {
                display.textContent = 'æŒ‘æˆ°æ¨¡å¼ (30ç§’å€’æ•¸)';
            }
        }
        
        function goToRulesPage() {
            const selectedCount = document.querySelector('input[name="playerCount"]:checked');
            if (!selectedCount) {
                alert('è«‹é¸æ“‡ç©å®¶äººæ•¸ï¼');
                return;
            }
            playerCount = parseInt(selectedCount.value);
            showPage('rulesPage');
        }

        function goToNameInputPage() {
            showPage('nameInputPage');
            renderPlayerInputs();
        }

        function renderPlayerInputs() {
            const playerInputsDiv = document.getElementById('playerInputs');
            playerInputsDiv.innerHTML = '';
            
            for (let i = 0; i < playerCount; i++) {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'player-input-group';
                
                const colorCircle = `<span class="score-color ${PLAYER_CLASSES[i]}" style="margin-right: 5px; background-color: var(--${PLAYER_CLASSES[i]}); width: 15px; height: 15px; display: inline-block; border-radius: 50%;"></span>`;
                
                inputGroup.innerHTML = `
                    <label>${colorCircle} ç©å®¶ ${i + 1}:</label>
                    <input type="text" id="playerName${i}" value="ç©å®¶ ${i + 1}" placeholder="ç©å®¶ ${i + 1}">
                `;
                playerInputsDiv.appendChild(inputGroup);
            }
        }

        function startGame() {
            players = [];
            for (let i = 0; i < playerCount; i++) {
                const nameInput = document.getElementById(`playerName${i}`).value || `ç©å®¶ ${i + 1}`;
                players.push({ 
                    id: i + 1,
                    name: nameInput, 
                    score: 0, 
                    class: PLAYER_CLASSES[i],
                    mistakeCount: 0,        // V7.0 æ–°å¢
                    isRetired: false        // V7.0 æ–°å¢
                });
            }

            initBoard();
            showPage('gameBoardPage');
            
            // æ ¹æ“šäººæ•¸ä½ˆå±€ç©å®¶å€
            if (playerCount <= 2) {
                document.getElementById('rightPlayerArea').style.display = 'none';
                document.getElementById('leftPlayerArea').style.width = '50%'; 
                document.getElementById('gameSection').style.width = '50%'; 
            } else {
                document.getElementById('rightPlayerArea').style.display = 'block';
                document.getElementById('leftPlayerArea').style.width = '25%'; 
                document.getElementById('gameSection').style.width = '50%'; 
            }
            
            startTurn();
        }

        function initBoard() {
            const gameBoard = document.getElementById('gameBoard');
            gameBoard.innerHTML = '';
            cells = [];
            
            const allProducts = [];
            for (let i = 1; i <= 10; i++) {
                for (let j = 1; j <= 10; j++) {
                    allProducts.push(i * j);
                }
            }
            const uniqueProducts = Array.from(new Set(allProducts));
            boardValues = getRandomUnique(uniqueProducts, BOARD_SIZE * BOARD_SIZE);
            availableCells = boardValues.slice(); 

            boardValues.forEach((value, index) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.textContent = value;
                cell.dataset.value = value;
                cell.dataset.owner = 0;
                cell.dataset.index = index;
                cell.onclick = handleCellClick;
                gameBoard.appendChild(cell);
                cells.push(cell);
            });
            
            document.getElementById('diceDisplay').innerHTML = '';
            document.getElementById('selectedProduct').textContent = '';
            document.getElementById('gameFeedback').textContent = 'è«‹é»æ“Šã€Œæ“²éª°å­ã€é–‹å§‹å›åˆã€‚';
            document.getElementById('rollDiceButton').disabled = false;
            document.getElementById('reRollButton').disabled = true;
        }
        
        function createPlayerInfoItem(player) {
            const infoDiv = document.createElement('div');
            infoDiv.id = `info-${player.id}`;
            infoDiv.className = `player-info-item ${player.class} ${player.isRetired ? 'retired' : ''}`;
            infoDiv.style.backgroundColor = player.isRetired ? `var(--retired-color)` : `var(--${player.class})`;
            
            const statusText = player.isRetired ? 'å·²æ£„æ¬Š' : `å¤±èª¤: ${player.mistakeCount} / ${MISTAKE_LIMIT}`;

            infoDiv.innerHTML = `
                <div class="player-score-name">${player.name}</div>
                <div class="score-value">åˆ†æ•¸: ${player.score}</div>
                <div class="timer-display" id="timer-${player.id}">00:00</div>
                <div class="mistake-info">${statusText}</div>
            `;
            return infoDiv;
        }

        function updateScoreDisplay() {
            const leftInfo = document.getElementById('playerInfoLeft');
            const rightInfo = document.getElementById('playerInfoRight');
            leftInfo.innerHTML = '';
            rightInfo.innerHTML = '';
            
            if (playerCount <= 2) {
                players.forEach(p => leftInfo.appendChild(createPlayerInfoItem(p)));
            } else {
                leftInfo.appendChild(createPlayerInfoItem(players[0]));
                leftInfo.appendChild(createPlayerInfoItem(players[1]));
                if (players[2]) rightInfo.appendChild(createPlayerInfoItem(players[2]));
                if (players[3]) rightInfo.appendChild(createPlayerInfoItem(players[3]));
            }
            
            // çªå‡ºé¡¯ç¤ºç•¶å‰ç©å®¶ (å¦‚æœä»–æ²’æœ‰æ£„æ¬Š)
            document.querySelectorAll('.player-info-item').forEach(el => el.classList.remove('current-turn'));
            const currentPlayer = players[currentPlayerIndex];
            if (!currentPlayer.isRetired) {
                const currentTurnElement = document.getElementById(`info-${currentPlayer.id}`);
                if (currentTurnElement) {
                    currentTurnElement.classList.add('current-turn');
                }
            }
        }
        
        function getNextActivePlayerIndex(startIndex) {
            let nextIndex = startIndex;
            for (let i = 0; i < players.length; i++) {
                nextIndex = (nextIndex + 1) % players.length;
                if (!players[nextIndex].isRetired) {
                    return nextIndex;
                }
                if (nextIndex === startIndex) break; // å¾ªç’°äº†ä¸€åœˆ
            }
            return -1; // æ²’æœ‰æ´»èºç©å®¶
        }


        function startTurn() {
            // æª¢æŸ¥æ˜¯å¦åªå‰©ä¸€å€‹ç©å®¶ (éŠæˆ²çµæŸæ¢ä»¶)
            if (players.filter(p => !p.isRetired).length <= 1) {
                checkGameOver();
                return;
            }

            // è·³éå·²æ£„æ¬Šç©å®¶
            if (players[currentPlayerIndex].isRetired) {
                currentPlayerIndex = getNextActivePlayerIndex(currentPlayerIndex);
            }
            
            // å¦‚æœæ‰¾åˆ°çš„ä¸‹ä¸€å€‹ç©å®¶ä»ç„¶æ˜¯æ£„æ¬Šçš„ï¼Œèªªæ˜é‚è¼¯æœ‰å•é¡Œï¼Œæˆ–è€…æ²’æœ‰æ´»èºç©å®¶äº†
            if (currentPlayerIndex === -1 || players[currentPlayerIndex].isRetired) {
                checkGameOver();
                return;
            }
            
            clearInterval(timerInterval);
            timeInSeconds = (gameMode === 'challenge') ? CHALLENGE_TIME : 0;
            skipCount = 0;

            document.getElementById('rollDiceButton').disabled = false;
            document.getElementById('reRollButton').disabled = true;
            document.getElementById('gameFeedback').textContent = `è«‹é»æ“Šã€Œæ“²éª°å­ã€é–‹å§‹å›åˆã€‚`;
            document.getElementById('diceDisplay').innerHTML = '';
            document.getElementById('selectedProduct').textContent = '';
            currentProduct = 0;
            selectedDice = [];

            updateScoreDisplay();
            updateTimerDisplay(); 
        }
        
        function updateTimerDisplay() {
            players.forEach(p => {
                const timerElement = document.getElementById(`timer-${p.id}`);
                if (timerElement) {
                    timerElement.textContent = (p.isRetired) ? 'æ£„æ¬Š' : (gameMode === 'challenge' ? '00:30' : '00:00');
                    timerElement.style.color = p.isRetired ? 'var(--text-on-color)' : 'var(--text-on-color)';
                }
            });

            const currentPlayer = players[currentPlayerIndex];
            if (currentPlayer.isRetired) return;

            const timerDisplay = document.getElementById(`timer-${currentPlayer.id}`);
            if (!timerDisplay) return;

            let minutes, seconds;
            
            if (gameMode === 'learning') {
                minutes = String(Math.floor(timeInSeconds / 60)).padStart(2, '0');
                seconds = String(timeInSeconds % 60).padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
            } else { 
                minutes = String(Math.floor(timeInSeconds / 60)).padStart(2, '0');
                seconds = String(timeInSeconds % 60).padStart(2, '0');
                timerDisplay.textContent = `${minutes}:${seconds}`;
                if (timeInSeconds <= 10) {
                    timerDisplay.style.color = 'var(--player1-color)'; 
                } else {
                    timerDisplay.style.color = 'var(--text-on-color)';
                }
            }
        }

        function timerTick() {
            if (gameMode === 'learning') {
                timeInSeconds++;
            } else { 
                timeInSeconds--;
                if (timeInSeconds < 0) {
                    clearInterval(timerInterval);
                    document.getElementById('gameFeedback').textContent = `æ™‚é–“åˆ°ï¼è‡ªå‹•æ›åˆ°ä¸‹ä¸€ä½ç©å®¶ã€‚`;
                    switchTurn(); 
                    return;
                }
            }
            updateTimerDisplay();
        }

        // --- éª°å­èˆ‡æ“ä½œé‚è¼¯ ---

        function handleRoll(forceSolvable = false) {
            clearInterval(timerInterval); 
            timeInSeconds = (gameMode === 'challenge') ? CHALLENGE_TIME : 0; 
            timerInterval = setInterval(timerTick, 1000); 
            
            document.getElementById('rollDiceButton').disabled = true;
            document.getElementById('reRollButton').disabled = false;
            
            if (forceSolvable) {
                currentDice = generateSolvableRolls(availableCells);
                document.getElementById('gameFeedback').textContent = `ç³»çµ±å¼·åˆ¶ç”¢ç”Ÿæœ‰è§£éª°æ•¸ï¼Œè«‹å‹™å¿…ä½”é ˜ï¼`;
            } else {
                currentDice = generateRandomRolls();
                document.getElementById('gameFeedback').textContent = `è«‹é»æ“Šå…¶ä¸­å…©å€‹æ•¸å­—è¨ˆç®—ä¹˜ç©ã€‚`;
            }

            renderDiceDisplay();
        }
        
        function generateRandomRolls() {
             const rolls = [];
            while(rolls.length < 3) {
                let newRoll = getRandomInt(1, 10);
                const count = rolls.filter(r => r === newRoll).length;
                if (count < 2) {
                    rolls.push(newRoll);
                }
            }
            return rolls;
        }
        
        function generateSolvableRolls(available) {
            let solvableProduct;
            let factor1, factor2;
            do {
                solvableProduct = available[getRandomInt(0, available.length - 1)];
                factor1 = 0;
                factor2 = 0;
                for(let i = 1; i <= 10; i++) {
                    if (solvableProduct % i === 0 && solvableProduct / i <= 10) {
                        factor1 = i;
                        factor2 = solvableProduct / i;
                        break;
                    }
                }
            } while (factor1 === 0 || factor2 === 0);

            let rolls = [factor1, factor2, getRandomInt(1, 10)];
            while (rolls[0] === rolls[1] && rolls[1] === rolls[2]) {
                rolls[2] = getRandomInt(1, 10);
            }
            return rolls;
        }

        function renderDiceDisplay() {
            const diceDisplay = document.getElementById('diceDisplay');
            diceDisplay.innerHTML = '';
            selectedDice = [];
            currentProduct = 0;
            document.getElementById('selectedProduct').textContent = '';
            
            currentDice.forEach((roll, index) => {
                const dice = document.createElement('div');
                dice.className = 'dice-number';
                dice.textContent = roll;
                dice.dataset.index = index;
                dice.onclick = handleDiceClick;
                diceDisplay.appendChild(dice);
            });
        }
        
        function handleDiceClick(event) {
            const diceElement = event.target;
            const index = parseInt(diceElement.dataset.index);
            
            if (selectedDice.includes(index)) {
                selectedDice = selectedDice.filter(i => i !== index);
                diceElement.classList.remove('dice-selected');
            } else if (selectedDice.length < 2) {
                selectedDice.push(index);
                diceElement.classList.add('dice-selected');
            }
            
            document.querySelectorAll('.dice-number').forEach((d, i) => {
                if (!selectedDice.includes(i)) {
                    d.classList.remove('dice-selected');
                }
            });

            if (selectedDice.length === 2) {
                const num1 = currentDice[selectedDice[0]];
                const num2 = currentDice[selectedDice[1]];
                currentProduct = num1 * num2;
                
                document.getElementById('selectedProduct').textContent = `æ‚¨é¸æ“‡çš„æ•¸å­—æ˜¯ ${num1} å’Œ ${num2}`;
                
                const targetCell = cells.find(c => parseInt(c.dataset.value) === currentProduct);
                const isAvailable = targetCell && parseInt(targetCell.dataset.owner) === 0;

                if (!isAvailable) {
                    // V7.0: æ•¸å­—é¸éŒ¯ï¼Œçµ¦äºˆæç¤º
                    showSmartModal(`æ‚¨é¸æ“‡çš„æ•¸å­— ${num1} å’Œ ${num2} ç„¡æ³•ä½”é ˜ã€‚è«‹é‡æ–°é¸æ“‡ã€‚`, () => {
                        document.getElementById('smartModal').style.display = 'none';
                        // ä¸è¨ˆå…¥å¤±èª¤æ¬¡æ•¸ï¼Œä½†è¦æ±‚ç©å®¶é‡æ–°é¸æ“‡éª°å­
                        selectedDice = [];
                        currentProduct = 0;
                        document.querySelectorAll('.dice-number').forEach(d => d.classList.remove('dice-selected'));
                        document.getElementById('selectedProduct').textContent = '';
                        document.getElementById('gameFeedback').textContent = 'è«‹é‡æ–°é¸æ“‡å…¶ä¸­å…©å€‹æ•¸å­—è¨ˆç®—ä¹˜ç©ã€‚';
                    });
                } else {
                    document.getElementById('gameFeedback').textContent = `è«‹é»æ“Šæ£‹ç›¤ä¸Šçš„ä¹˜ç©æ•¸å­—ã€‚`;
                }
                
            } else {
                currentProduct = 0;
                document.getElementById('selectedProduct').textContent = '';
                document.getElementById('gameFeedback').textContent = `è«‹é»æ“Šå…¶ä¸­å…©å€‹æ•¸å­—è¨ˆç®—ä¹˜ç©ã€‚`;
            }
        }
        
        /**
         * V7.0: è™•ç†é‡éª°æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼ŒåŒ…å«å¤±èª¤æ‡²ç½°é‚è¼¯
         */
        function handleReRoll() {
            const currentPlayer = players[currentPlayerIndex];
            const solvableCombo = checkSolvable(currentDice, availableCells);

            if (solvableCombo) {
                // (2) å¯¦éš›ä¸Šæœ‰è§£ï¼Œä½†ç©å®¶é¸æ“‡é‡éª° -> è¨ˆå…¥å¤±èª¤
                currentPlayer.mistakeCount++;
                const remaining = MISTAKE_LIMIT - currentPlayer.mistakeCount;
                const [n1, n2] = solvableCombo;
                
                if (currentPlayer.mistakeCount > MISTAKE_LIMIT) {
                    // ç¬¬ 4 æ¬¡å¤±èª¤ -> æ£„æ¬Š
                    retirePlayer(currentPlayer);
                    
                } else {
                    // ç¬¬ 1-3 æ¬¡å¤±èª¤ -> æç¤ºä¸¦ç¹¼çºŒ
                    const message = `æ‚¨å¯ä»¥é¸æ“‡ **${n1}** å’Œ **${n2}**ã€‚å¤±èª¤æ¬¡æ•¸å·²ç´¯ç© ${currentPlayer.mistakeCount} æ¬¡ï¼Œæ‚¨é‚„å‰©ä¸‹ ${remaining} æ¬¡æ©Ÿæœƒã€‚`;
                    
                    showSmartModal(message, () => {
                        document.getElementById('smartModal').style.display = 'none';
                    });
                }
                
            } else {
                // (1) ç¢ºå¯¦ç„¡è§£ -> éœé»˜é‡éª° (ä¸è¨ˆå¤±èª¤)
                skipCount++;
                document.getElementById('gameFeedback').textContent = `å·²é‡éª°ã€‚`;
                
                if (skipCount >= 3) {
                    handleRoll(true); 
                } else {
                    handleRoll(); 
                }
            }
        }
        
        function retirePlayer(player) {
            clearInterval(timerInterval);
            player.isRetired = true;
            
            showSmartModal(`âš ï¸ ${player.name} å¤±èª¤æ¬¡æ•¸å·²é”ä¸Šé™ï¼Œ**è¢«åˆ¤æ£„æ¬Š**ï¼`, () => {
                document.getElementById('smartModal').style.display = 'none';
                switchTurn(); 
            });
        }
        
        function showSmartModal(message, callback) {
            document.getElementById('modalMessage').innerHTML = message;
            const confirmBtn = document.getElementById('modalConfirmButton');
            
            confirmBtn.onclick = null;
            confirmBtn.onclick = callback;
            
            document.getElementById('smartModal').style.display = 'flex';
        }


        function handleCellClick(event) {
            const cell = event.target;
            const cellValue = parseInt(cell.dataset.value);
            const owner = parseInt(cell.dataset.owner);
            
            if (currentProduct === 0 || selectedDice.length !== 2) {
                document.getElementById('gameFeedback').textContent = 'è«‹å…ˆé¸æ“‡å…©å€‹æ•¸å­—ä¸¦ç¢ºèªä¹˜ç©ï¼';
                return;
            }
            if (cellValue !== currentProduct) {
                document.getElementById('gameFeedback').textContent = `æ‚¨é»æ“Šçš„æ•¸å­—ä¸æ˜¯ä¹˜ç© ${currentProduct}ã€‚`;
                return;
            }
            if (owner !== 0) {
                document.getElementById('gameFeedback').textContent = 'é€™å€‹æ–¹æ ¼å·²ç¶“è¢«ä½”é ˜äº†ï¼';
                return;
            }
            
            const currentPlayer = players[currentPlayerIndex];
            
            cell.dataset.owner = currentPlayer.id;
            cell.className = `cell ${currentPlayer.class}`;
            
            availableCells = availableCells.filter(v => v !== cellValue);
            
            const currentScore = calculateScore(cell);
            currentPlayer.score += currentScore;
            
            document.getElementById('gameFeedback').textContent = `âœ… ${currentPlayer.name} æˆåŠŸä½”é ˜ ${currentProduct}ï¼å¾—åˆ†: ${currentScore}ã€‚`;
            
            switchTurn();
        }

        function calculateScore(cell) {
            let score = 1; 
            const cellIndex = parseInt(cell.dataset.index);
            const ownerId = parseInt(cell.dataset.owner);
            const cols = BOARD_SIZE;
            
            const neighbors = [
                cellIndex - cols,   // ä¸Š
                cellIndex + cols,   // ä¸‹
                cellIndex - 1,      // å·¦
                cellIndex + 1       // å³
            ];
            
            let isConnected = false;
            
            neighbors.forEach(nIndex => {
                if (nIndex >= 0 && nIndex < cells.length) {
                    // ç¢ºä¿å·¦å³é„°å±…ä¸æœƒè·¨è¡Œ
                    if ((nIndex === cellIndex - 1 && (cellIndex % cols === 0)) || 
                        (nIndex === cellIndex + 1 && ((cellIndex + 1) % cols === 0))) {
                        return;
                    }
                    
                    const neighbor = cells[nIndex];
                    if (parseInt(neighbor.dataset.owner) === ownerId) {
                        isConnected = true;
                    }
                }
            });

            if (isConnected) {
                score *= 2; // ç›¸é€£å¾—åˆ†ç¿»å€
            }
            return score;
        }

        function switchTurn() {
            clearInterval(timerInterval);
            
            // æª¢æŸ¥æ˜¯å¦åªå‰©ä¸€å€‹æ´»èºç©å®¶
            if (players.filter(p => !p.isRetired).length <= 1) {
                checkGameOver();
                return;
            }
            
            // æ‰¾åˆ°ä¸‹ä¸€å€‹æ´»èºç©å®¶
            const nextIndex = getNextActivePlayerIndex(currentPlayerIndex);

            if (nextIndex === -1) {
                checkGameOver(); // æ‰¾ä¸åˆ°æ´»èºç©å®¶ï¼ŒéŠæˆ²çµæŸ
            } else {
                currentPlayerIndex = nextIndex;
                startTurn();
            }
        }

        function checkGameOver() {
            const activePlayers = players.filter(p => !p.isRetired);
            
            // éŠæˆ²çµæŸæ¢ä»¶ï¼šæ‰€æœ‰æ–¹æ ¼è¢«ä½”é ˜ AND/OR åªæœ‰ä¸€å€‹æˆ–é›¶å€‹æ´»èºç©å®¶
            if (availableCells.length === 0 || activePlayers.length <= 1) {
                showGameOver();
            }
        }
        
        function showGameOver() {
            clearInterval(timerInterval);
            
            // æ’é™¤æ£„æ¬Šç©å®¶ä¾†è¨ˆç®—è´å®¶
            const activePlayers = players.filter(p => !p.isRetired);
            let contenders = activePlayers.length > 0 ? activePlayers : players; // å¦‚æœéƒ½æ£„æ¬Šï¼Œå‰‡æ‰€æœ‰ç©å®¶éƒ½æ˜¯ç«¶çˆ­è€…

            let maxScore = -1;
            let winners = [];
            
            contenders.forEach(player => {
                if (player.score > maxScore) {
                    maxScore = player.score;
                    winners = [player.name];
                } else if (player.score === maxScore) {
                    winners.push(player.name);
                }
            });
            
            const modal = document.getElementById('gameOverModal');
            const winnerMessage = document.getElementById('winnerMessage');
            
            if (activePlayers.length <= 1 && players.length > 1) {
                 // å› æ£„æ¬Šè€ŒçµæŸï¼Œæ´»èºç©å®¶ç²å‹ (å¦‚æœå­˜åœ¨)
                if (activePlayers.length === 1) {
                    winnerMessage.textContent = `æ­å–œ ${activePlayers[0].name} ç²å‹ï¼æ‰€æœ‰å…¶ä»–ç©å®¶å‡å·²æ£„æ¬Šã€‚`;
                } else {
                    winnerMessage.textContent = `æ‰€æœ‰ç©å®¶å‡å·²æ£„æ¬Šï¼éŠæˆ²çµæŸï¼Œå¾—åˆ†æœ€é«˜çš„ç©å®¶ï¼ˆ${winners.join(' å’Œ ')}ï¼‰ç²å‹ã€‚`;
                }
            } else if (winners.length > 1) {
                winnerMessage.textContent = `å¹³æ‰‹ï¼ç²å‹è€…æ˜¯ï¼š${winners.join(' å’Œ ')}ï¼Œç©åˆ†çš†ç‚º ${maxScore} åˆ†ï¼`;
            } else {
                winnerMessage.textContent = `æ­å–œ ${winners[0]} ç²å‹ï¼Œç²å¾—æœ€é«˜ç©åˆ† ${maxScore} åˆ†ï¼`;
            }
            
            modal.style.display = 'flex';
        }
        
        function restartGame() {
            document.getElementById('gameOverModal').style.display = 'none';
            clearInterval(timerInterval);

            // é‡ç½®æ‰€æœ‰ç‹€æ…‹
            players = [];
            cells = [];
            currentPlayerIndex = 0;
            currentDice = [0, 0, 0];
            selectedDice = [];
            currentProduct = 0;
            playerCount = 2; 
            gameMode = 'learning';
            skipCount = 0;
            timeInSeconds = 0;
            
            showPage('modeSelectPage'); 
            setGameMode('learning');
        }

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            showPage('modeSelectPage');
            setGameMode('learning');
        });
    </script>
</body>
</html>
